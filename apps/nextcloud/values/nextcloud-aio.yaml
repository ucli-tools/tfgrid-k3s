# Nextcloud All-in-One Helm Values for HA Deployment
image:
  repository: nextcloud/all-in-one
  tag: latest
  pullPolicy: IfNotPresent

nextcloud:
  host: ${NEXTCLOUD_DOMAIN}
  username: admin
  password: "" # Will be auto-generated

  configs:
    overwrite.cli.url: "https://${NEXTCLOUD_DOMAIN}"
    trusted_domains: "${NEXTCLOUD_DOMAIN}"
    trusted_proxies: "10.0.0.0/8"
    overwriteprotocol: https
    default_phone_region: US

  mail:
    enabled: true
    fromAddress: noreply
    domain: ${NEXTCLOUD_DOMAIN}
    smtp:
      secure: ssl
      port: 465
      authtype: LOGIN

persistence:
  enabled: true
  existingClaim: nextcloud-data

postgresql:
  enabled: true
  auth:
    database: nextcloud
    username: nextcloud
  primary:
    persistence:
      enabled: true
      existingClaim: nextcloud-db
      size: ${NEXTCLOUD_DB_SIZE}Gi

redis:
  enabled: true
  auth:
    enabled: true
  master:
    persistence:
      enabled: true
      existingClaim: nextcloud-redis
      size: ${NEXTCLOUD_REDIS_SIZE}Gi

# High Availability Settings - Dynamically configured based on cluster size
replicaCount: ${NEXTCLOUD_REPLICA_COUNT:-1}

# Resource allocation - Dynamically calculated based on cluster resources
resources:
  limits:
    cpu: ${NEXTCLOUD_CPU_LIMITS:-4}
    memory: ${NEXTCLOUD_MEM_LIMITS:-8192}Mi
  requests:
    cpu: ${NEXTCLOUD_CPU_REQUESTS:-2}
    memory: ${NEXTCLOUD_MEM_REQUESTS:-4096}Mi

# Nextcloud apps to enable
apps:
  enabled:
    - admin_audit
    - bruteforcesettings
    - calendar
    - contacts
    - deck
    - files_external
    - files_pdfviewer
    - files_rightclick
    - files_versions
    - files_trashbin
    - mail
    - notes
    - notifications
    - password_policy
    - photos
    - richdocuments
    - spreed
    - tasks
    - text
    - twofactor_totp
    - user_ldap
    - viewer

# Monitoring and metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: false

# Backup configuration
cronjob:
  enabled: true

# Security settings
securityContext:
  runAsUser: 33
  runAsGroup: 33
  fsGroup: 33

# Pod disruption budget for HA - dynamically configured
podDisruptionBudget:
  enabled: ${NEXTCLOUD_HA_ENABLED:-true}
  minAvailable: ${NEXTCLOUD_PDB_MIN_AVAILABLE:-1}

# Affinity settings for HA distribution - conditionally enabled
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - nextcloud
        topologyKey: kubernetes.io/hostname

# Tolerations for HA deployment
tolerations:
- key: "node-role.kubernetes.io/master"
  operator: "Exists"
  effect: "NoSchedule"
- key: "node-role.kubernetes.io/control-plane"
  operator: "Exists"
  effect: "NoSchedule"